{"version":3,"sources":["attendance.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\r\n * Created by Elvis on 2017/6/29.\r\n */\r\nvar Attendance = function (zonediv, zone) {\r\n    var self = this\r\n    this.zonediv = zonediv;\r\n    this.zone = zone;\r\n    this.currentEvent = null;\r\n    common.attendance.push(this)\r\n    var timer = 0\r\n\r\n    var attendanceSummaryTpl = `<div class=\"attendance-summary\">\r\n            <h3 class=\"title\">{{=it.event_name}}</h3>\r\n            <p class=\"info\">应到人数&nbsp;{{=it.total}}</p>\r\n            <p class=\"info\">已到&nbsp;{{=it.avail_total}}</p>\r\n        </div>`\r\n    var attendanceNullTpl = `<div class=\"attendance-summary\">\r\n            <p>当前无考勤</p>\r\n        </div>`\r\n\r\n    var attendanceListTpl = `<div class=\"attendance-list\" id=\"attendanceList\">\r\n            {{~it:student:index}}\r\n            <div class=\"attendance-item animated\" data-id=\"{{=student.student_id}}\">\r\n                <div class=\"attendance-avatar\">\r\n                    <img src=\"{{=student.avatar}}\" {{?student.state == '2'}}class=\"opacity\"{{?}}/>\r\n                </div>\r\n                <div class=\"attendance-info\">\r\n                    <p>{{=student.student_name}}</p>\r\n                </div>\r\n            </div>\r\n            {{~}}\r\n        </div>`\r\n\r\n    var attendancePopupTpl = `<div class=\"attendance-popup animated\" data-id=\"{{=it.id}}\">\r\n                <div class=\"attendance-popup-avatar\">\r\n                    <img src=\"{{=it.avatar}}\"/>\r\n                </div>\r\n                <div class=\"attendance-popup-info\">\r\n                    <p>签到时间：{{=moment().format('HH:mm:ss')}}</p>\r\n                </div>\r\n            </div>`\r\n\r\n    var checkin = function (student) {\r\n        if (!student.id) return\r\n        $('.attendance-item').each(function (index, node) {\r\n            if ($(node).data('id') == student.id) {\r\n                $(node).find('img').removeClass('opacity')\r\n                $(node).addClass('rubberBand')\r\n                setTimeout(function () {\r\n                    $(node).removeClass('rubberBand')\r\n                }, 1000)\r\n            }\r\n        })\r\n        $('.attendance-popup').remove()\r\n        var templ = doT.template(attendancePopupTpl)\r\n        $('body').append(templ(student))\r\n        clearTimeout(timer)\r\n        timer = setTimeout(function () {\r\n            $('.attendance-popup').remove()\r\n        }, 5000)\r\n    }\r\n\r\n    this.refreshAttendance = function () {\r\n        var now = Date.now()\r\n        var events = common.attendanceEvents.filter(function (event) {\r\n            return event.start_time < now\r\n        })\r\n        if (events.length > 0) {\r\n            self.currentEvent = events[events.length - 1]\r\n            $.ajax({\r\n                url: `${common.baseUrl}/classrooms/${common.classRoom.id}/attendancesummary?event_id=${self.currentEvent.id}`,\r\n                dataType: 'json'\r\n            }).then(function (res) {\r\n                console.log('get attendancesummary', res)\r\n                var templ = doT.template(attendanceSummaryTpl)\r\n                $(self.zonediv).html(templ(res.data))\r\n                $('#attendanceList').remove()\r\n                if (now < self.currentEvent.end_time) {\r\n                    var templ = doT.template(attendanceListTpl)\r\n                    $('body').append(templ(res.data.dtls))\r\n                }\r\n            }).catch(function (err) {\r\n                console.log(err.message)\r\n            })\r\n        } else {\r\n            this.zonediv.html(attendanceNullTpl)\r\n        }\r\n    }\r\n\r\n    this.init = function () {\r\n        setInterval(self.refreshAttendance, 300000)\r\n        self.refreshAttendance()\r\n    }\r\n\r\n    this.resize = function (scalew, scaleh) {\r\n        zonediv.css({\r\n            'box-sizing': 'border-box',\r\n            'border-color': zone.bdcolor,\r\n            'border-style': zone.bdstyle,\r\n            'border-width': (parseInt(zone.bdwidth) / scalew) + 'px',\r\n            'border-radius': (parseInt(zone.bdradius) / scalew) + 'px',\r\n            'color': zone.color,\r\n            'font-family': zone.fontfamily,\r\n            'font-size': (parseInt(zone.fontsize) / scalew) + 'px',\r\n            'text-align': zone.align,\r\n            'font-weight': zone.fontweight,\r\n            'font-style': zone.fontstyle,\r\n            'overflow': 'auto'\r\n        });\r\n    };\r\n\r\n    this.swipe = function (hardId) {\r\n        if (self.currentEvent && self.currentEvent.end_time > Date.now()) {\r\n            var student = common.students.find(function (student) {\r\n                return student['hard_id'] == hardId\r\n            })\r\n            if (student) {\r\n                checkin(student)\r\n                var data = JSON.stringify({\r\n                    'event_id':self.currentEvent.id,\r\n                    'hard_id': student['hard_id'],\r\n                    'student_id': student.id,\r\n                    'classroom_id': common.classRoom.id,\r\n                    ts: Date.now()\r\n                })\r\n                $.ajax({\r\n                    url: `${common.baseUrl}/students/${student.id}/attendance?event_time=${Date.now()}`,\r\n                    type: 'post',\r\n                    contentType: 'application/json',\r\n                    data: data\r\n                }).then(function (res) {\r\n                    setTimeout(self.refreshAttendance, 1000)\r\n                }).catch(function (err) {\r\n                    console.log(JSON.stringify(err))\r\n                })\r\n            }\r\n        }\r\n    }\r\n}\r\n"]}